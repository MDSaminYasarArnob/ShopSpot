<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ShopSpot App - Persistent Lists</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        :root {
            --mint-green: #B2DFDB; --mint-green-darker: #00796B; --blush-pink: #F8BBD0;
            --baby-blue: #B3E5FC; --white: #FFFFFF; --background-white: #FAFAFA;
            --text-dark: #004D40; --text-medium: #26A69A; --text-light: #757575;
            --border-color: #E0E0E0; --font-weight-title: 700; --font-weight-header: 600;
            --font-weight-item-name: 500; --font-weight-details: 400;
            --border-radius: 12px; --shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            --shadow-light: 0 2px 6px rgba(0, 0, 0, 0.05);
        }
        html, body {
            margin: 0; padding: 0; height: 100%; overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #E0E0E0;
        }
        .app-container {
            width: 100%; height: 100%; max-width: 414px; margin: 0 auto;
            background-color: var(--background-white); display: flex; flex-direction: column;
            position: relative; overflow: hidden; box-shadow: 0 0 20px rgba(0,0,0,0.15);
        }
        .app-header-container { padding: 20px 20px 0; margin-top: 5px; flex-shrink: 0; }
        .app-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .app-title { font-size: 32px; font-weight: var(--font-weight-title); color: var(--text-dark); margin: 0; }
        .app-icon-placeholder svg { width: 24px; height: 24px; fill: var(--text-dark); }
        .app-icon-placeholder {
            width: 40px; height: 40px; background-color: var(--mint-green); border-radius: 8px;
            display: flex; justify-content: center; align-items: center; color: var(--text-dark);
            font-size: 20px; font-weight: bold;
        }
        .top-tabs {
            display: flex; justify-content: space-around; border-bottom: 1px solid var(--border-color);
            margin-bottom: 20px; flex-shrink: 0;
        }
        .top-tabs .tab-button {
            background: none; border: none; padding: 10px 15px 12px; font-size: 16px;
            font-weight: var(--font-weight-header); color: var(--text-light); cursor: pointer;
            position: relative; flex-grow: 1; text-align: center;
        }
        .top-tabs .tab-button.active { color: var(--text-dark); }
        .top-tabs .tab-button.active::after {
            content: ''; position: absolute; bottom: -1px; left: 0; right: 0; height: 3px;
            background-color: var(--mint-green); border-radius: 3px 3px 0 0;
        }
        .content-area {
            flex-grow: 1; padding: 0 20px 20px; overflow-y: auto; -webkit-overflow-scrolling: touch;
        }
        .master-add-list-btn {
            width: 100%; background-color: var(--mint-green); color: var(--text-dark); border: none;
            padding: 15px; border-radius: var(--border-radius); font-size: 16px;
            font-weight: var(--font-weight-header); cursor: pointer; margin-bottom: 25px;
            box-shadow: var(--shadow-light); text-align: center;
        }
        #lists-container .grocery-list-card:last-child { margin-bottom: 0; }
        .grocery-list-card {
            background-color: var(--white); border-radius: var(--border-radius); padding: 18px;
            margin-bottom: 25px; box-shadow: var(--shadow);
            transition: opacity 0.3s ease, transform 0.3s ease;
        }
        .grocery-list-card.deleting { opacity: 0; transform: scale(0.95); }
        .list-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
        .list-title { font-size: 20px; font-weight: var(--font-weight-header); color: var(--text-dark); margin: 0; }
        .list-date-stamp {
            font-size: 12px; color: var(--text-light); font-weight: var(--font-weight-details);
            margin-top: -12px; margin-bottom: 15px;
        }
        .list-actions { display: flex; gap: 5px; }
        .icon-btn {
            background: none; border: none; color: var(--text-medium); cursor: pointer;
            padding: 5px; display: inline-flex; align-items: center; justify-content: center;
            border-radius: 50%; transition: background-color 0.2s ease, color 0.2s ease;
        }
        .icon-btn:hover { background-color: rgba(0, 0, 0, 0.05); color: var(--text-dark); }
        .icon-btn svg { pointer-events: none; }

        .item-list { list-style: none; padding: 0; margin: 0; }
        .item { display: flex; align-items: center; padding: 10px 0; border-bottom: 1px solid #f0f0f0; }
        .item:last-child { border-bottom: none; }
        .item .checkbox-container { margin-right: 12px; display: flex; align-items: center; }
        .item .checkbox-container input[type="checkbox"] {
            appearance: none; -webkit-appearance: none; width: 22px; height: 22px;
            border: 2px solid var(--mint-green); border-radius: 6px; cursor: pointer;
            position: relative; margin-right: 0;
        }
        .item .checkbox-container input[type="checkbox"]:checked { background-color: var(--mint-green); }
        .item .checkbox-container input[type="checkbox"]:checked::before {
            content: '✔'; font-size: 14px; color: var(--text-dark); position: absolute;
            top: 50%; left: 50%; transform: translate(-50%, -50%); font-weight: bold;
        }
        .item-info { flex-grow: 1; min-width: 0; margin-right: 5px; }
        .item-name {
            font-size: 16px; font-weight: var(--font-weight-item-name); color: var(--text-dark);
            display: block; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
        .item-weight { font-size: 13px; font-weight: var(--font-weight-details); color: var(--text-light); margin-left: 5px; }
        .item-details {
            font-size: 14px; font-weight: var(--font-weight-details); color: var(--text-medium);
            text-align: right; flex-shrink: 0;  margin-right: 5px;
        }
        .item-details .price-value {}
        .item-details .notes-value { font-size: 12px; color: var(--text-light); display: block; }
        .item-actions-inline { margin-left: auto; display: flex; gap: 5px; padding-left:10px;}
        
        .add-item-to-list-btn {
            display: block; width: calc(100% - 10px); margin: 15px auto 5px; padding: 10px;
            background-color: var(--mint-green); color: var(--text-dark); border: none;
            border-radius: 8px; font-size: 14px; font-weight: 500; cursor: pointer; text-align: center;
        }
        .add-item-to-list-btn:hover { background-color: #A0D2CB; }
        .list-total-price {
            margin-top: 15px; padding-top: 10px; border-top: 1px solid var(--border-color);
            text-align: right; font-size: 16px; font-weight: var(--font-weight-header); color: var(--text-dark);
        }
        .list-total-price .total-label { font-weight: var(--font-weight-details); color: var(--text-medium); margin-right: 5px;}
        
        .bottom-nav {
            display: flex; justify-content: space-around; background-color: var(--white);
            border-top: 1px solid var(--border-color); padding: 8px 0;
            padding-bottom: calc(8px + env(safe-area-inset-bottom));
            box-shadow: 0 -2px 5px rgba(0,0,0,0.05); flex-shrink: 0;
        }
        .bottom-nav .nav-item {
            background: none; border: none; cursor: pointer; display: flex; flex-direction: column;
            align-items: center; color: var(--text-light); font-size: 11px; font-weight: 500; padding: 5px 10px;
        }
        .bottom-nav .nav-item.active .icon svg { fill: var(--mint-green-darker); }
        .bottom-nav .nav-item.active span { color: var(--mint-green-darker); }

        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        .modal {
            display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%;
            overflow: auto; background-color: rgba(0,0,0,0.5); justify-content: center; align-items: center;
        }
        .modal-content {
            background-color: var(--white); margin: auto; padding: 25px; border-radius: var(--border-radius);
            width: 85%; max-width: 320px; box-shadow: var(--shadow); text-align: left;
        }
        .modal-content h3 { margin-top: 0; margin-bottom:20px; color: var(--text-dark); text-align:center; }
        .modal-content label { display: block; margin-bottom: 5px; font-size: 14px; color: var(--text-dark); font-weight: 500; }
        .modal-content input[type="number"], .modal-content input[type="text"] {
            width: calc(100% - 22px); padding: 10px; margin-bottom: 15px;
            border: 1px solid var(--border-color); border-radius: 8px; box-sizing: border-box;
        }
        .modal-buttons { text-align: right; margin-top: 10px;}
        .modal-buttons button {
            padding: 10px 20px; margin-left: 10px; border-radius: 8px; border: none;
            cursor: pointer; font-weight: 500;
        }
        .modal-buttons .confirm-btn { background-color: var(--mint-green); color: var(--text-dark); }
        .modal-buttons .cancel-btn { background-color: #E0E0E0; color: var(--text-dark); }

        #history-tab-content-area { padding-top: 10px; }
        .history-date-group h4 {
            font-size: 16px; color: var(--text-dark); margin: 20px 0 10px;
            padding-bottom: 5px; border-bottom: 1px solid var(--border-color);
        }
        .history-list-card {
            background-color: var(--white); border-radius: var(--border-radius);
            margin-bottom: 15px; box-shadow: var(--shadow-light);
            border: 1px solid var(--baby-blue);
        }
        .history-list-header {
            padding: 12px 15px; cursor: pointer; display: flex;
            justify-content: space-between; align-items: center;
        }
        .history-list-header .title-date-group { flex-grow: 1; margin-right: 10px;}
        .history-list-header .list-title { font-size: 17px; }
        .history-list-header .original-date { font-size: 11px; color: var(--text-light); }
        .history-list-header .expand-icon::before { content: '▼'; font-size: 12px; }
        .history-list-card.expanded .history-list-header .expand-icon::before { content: '▲'; }
        /* Delete button for history items */
        .history-list-card .delete-history-btn { margin-left: 10px; }

        .history-item-list {
            list-style: none; padding: 0 15px 10px; margin: 0; max-height: 0;
            overflow: hidden; transition: max-height 0.3s ease-out, padding 0.3s ease-out;
        }
        .history-list-card.expanded .history-item-list { max-height: 500px; padding-top:10px; padding-bottom:10px; }
        .history-item {
            display: flex; justify-content: space-between; align-items: flex-start;
            padding: 8px 0; font-size: 14px; border-bottom: 1px dotted #f0f0f0;
        }
        .history-item:last-child { border-bottom: none; }
        .history-item-info .name { font-weight: 500; color: var(--text-dark); }
        .history-item-info .weight { font-size: 12px; color: var(--text-light); margin-left: 5px; }
        .history-item-details .price { color: var(--text-medium); }
        .history-item-details .status { font-size: 11px; color: var(--text-light); display:block; text-align:right; }
        .history-item-details .notes { font-size: 12px; color: var(--text-light); display:block; text-align:right; font-style: italic;}
    </style>
</head>
<body>
    <div class="app-container">
        <div class="app-header-container">
            <header class="app-header">
                <h1 class="app-title">ShopSpot</h1>
                <div class="app-icon-placeholder">
                    <svg viewBox="0 0 24 24"><path d="M7 18c-1.1 0-1.99.9-1.99 2S5.9 22 7 22s2-.9 2-2-.9-2-2-2zm10 0c-1.1 0-1.99.9-1.99 2S15.9 22 17 22s2-.9 2-2-.9-2-2-2zm-1.45-5c.75 0 1.41-.41 1.75-1.03l3.58-6.49A.996.996 0 0020.01 4H5.21l-.94-2H1v2h2l3.6 7.59-1.35 2.44C4.52 15.37 5.48 17 7 17h12v-2H7l1.1-2h7.45zM6.16 6h12.15l-2.76 5H8.53L6.16 6z"/></svg>
                </div>
            </header>
            <nav class="top-tabs">
                <button class="tab-button active" onclick="showTab('home-tab')">Lists</button>
                <button class="tab-button" onclick="showTab('history-tab')">History</button>
            </nav>
        </div>

        <main class="content-area">
            <div id="home-tab" class="tab-content active">
                <button class="master-add-list-btn" id="masterAddListButton">Add New List</button>
                <div id="lists-container">
                    <!-- Active Lists will be dynamically added here -->
                </div>
            </div>

            <div id="history-tab" class="tab-content">
                <div id="history-tab-content-area">
                     <p style="text-align: center; color: var(--text-light); margin-top: 20px;">No archived lists yet.</p>
                </div>
            </div>
        </main>

        <nav class="bottom-nav">
            <button class="nav-item active" onclick="showMainTab('home-tab', this)">
                <span class="icon"><svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 0 24 24" width="24px"><path d="M0 0h24v24H0V0z" fill="none"/><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8h5z"/></svg></span>
                <span>Lists</span>
            </button>
            <button class="nav-item" onclick="showMainTab('history-tab', this)">
                <span class="icon"><svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 0 24 24" width="24px"><path d="M0 0h24v24H0V0z" fill="none"/><path d="M13 3a9 9 0 0 0-9 9H1l3.89 3.89.07.14L9 12H6c0-3.87 3.13-7 7-7s7 3.13 7 7-3.13 7-7 7v-2c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5h1.83l-1.51-1.51.01-.01C6.04 10.15 6 11.07 6 12c0 3.87 3.13 7 7 7s7-3.13 7-7-3.13-7-7-7zm-1 5v5l4.25 2.52.77-1.28-3.52-2.09V8z"/></svg></span>
                <!-- Replaced History icon with a clock/history like icon -->
                <span>History</span>
            </button>
        </nav>
    </div>

    <!-- MODALS -->
    <div id="addNewListModal" class="modal"><div class="modal-content"><h3>Add New Grocery List</h3><label for="newListTitleInput">List Title:</label><input type="text" id="newListTitleInput" placeholder="e.g., Weekly Groceries"><div class="modal-buttons"><button class="cancel-btn" onclick="closeModal('addNewListModal')">Cancel</button><button class="confirm-btn" onclick="handleSaveNewList()">Save List</button></div></div></div>
    <div id="addNewItemModal" class="modal"><div class="modal-content"><h3>Add Item to List</h3><label for="newItemNameInput">Item Name:</label><input type="text" id="newItemNameInput" placeholder="e.g., Apples"><label for="newItemWeightInput">Weight (Optional):</label><input type="text" id="newItemWeightInput" placeholder="e.g., 1kg or 500g"><div class="modal-buttons"><button class="cancel-btn" onclick="closeModal('addNewItemModal')">Cancel</button><button class="confirm-btn" onclick="handleSaveNewItem()">Add Item</button></div></div></div>
    <div id="priceModal" class="modal"><div class="modal-content"><h3>Enter Price</h3><label for="itemPriceInput">Price:</label><input type="number" id="itemPriceInput" placeholder="e.g., 2.99" step="0.01"><label for="itemNotesInput">Optional Notes:</label><input type="text" id="itemNotesInput" placeholder="e.g., Organic"><div class="modal-buttons"><button class="cancel-btn" onclick="closePriceModal(false)">Cancel</button><button class="confirm-btn" onclick="closePriceModal(true)">Confirm</button></div></div></div>
    <div id="editListModal" class="modal"><div class="modal-content"><h3>Edit List Title</h3><label for="editListTitleInput">New List Title:</label><input type="text" id="editListTitleInput"><div class="modal-buttons"><button class="cancel-btn" onclick="closeModal('editListModal')">Cancel</button><button class="confirm-btn" onclick="handleSaveListTitleEdit()">Save</button></div></div></div>
    <div id="editItemModal" class="modal"><div class="modal-content"><h3>Edit Item</h3><label for="editItemNameInput">Item Name:</label><input type="text" id="editItemNameInput"><label for="editItemWeightInput">Weight (Optional):</label><input type="text" id="editItemWeightInput"><div class="modal-buttons"><button class="cancel-btn" onclick="closeModal('editItemModal')">Cancel</button><button class="confirm-btn" onclick="handleSaveItemEdit()">Save</button></div></div></div>
    <div id="confirmModal" class="modal"><div class="modal-content"><h3 id="confirmModalTitle">Confirm</h3><p id="confirmModalMessage"></p><div class="modal-buttons"><button class="cancel-btn" onclick="closeConfirmModal(false)">Cancel</button><button class="confirm-btn" id="confirmModalConfirmBtn" onclick="closeConfirmModal(true)">OK</button></div></div></div>

    <script>
        const { jsPDF } = window.jspdf;

        let currentCheckbox = null;
        let currentListCardForAction = null;
        let confirmModalCallback = null;
        let currentItemForAction = null; // Changed from currentItemForEdit for broader use

        let activeListsData = []; // For lists on the "Lists" tab
        let historyData = [];     // For lists on the "History" tab

        const ACTIVE_LISTS_STORAGE_KEY = 'shopSpotActiveLists';
        const HISTORY_STORAGE_KEY = 'shopSpotHistory';

        // --- Persistence Functions ---
        function saveData(key, data) {
            try { localStorage.setItem(key, JSON.stringify(data)); }
            catch (e) { console.error(`Error saving ${key}:`, e); }
        }
        function loadData(key) {
            const storedData = localStorage.getItem(key);
            if (storedData) {
                try { return JSON.parse(storedData); }
                catch (e) { console.error(`Error parsing ${key}:`, e); return []; }
            }
            return [];
        }

        // --- Generic Modal Functions ---
        function openModal(modalId) { document.getElementById(modalId).style.display = 'flex'; }
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
            // Clear inputs
            const inputs = document.getElementById(modalId).querySelectorAll('input[type="text"], input[type="number"]');
            inputs.forEach(input => input.value = '');
            if (modalId === 'editItemModal' || modalId === 'addNewItemModal') currentItemForAction = null;
            if (modalId === 'editListModal' || modalId === 'addNewListModal') currentListCardForAction = null;
        }

        // --- Tab Navigation ---
        function showTab(tabId) {
            document.querySelectorAll('.top-tabs .tab-button, .bottom-nav .nav-item').forEach(b => b.classList.remove('active'));
            document.querySelector(`.top-tabs .tab-button[onclick="showTab('${tabId}')"]`).classList.add('active');
            document.querySelector(`.bottom-nav .nav-item[onclick="showMainTab('${tabId}', this)"]`).classList.add('active');
            showMainTabContent(tabId);
        }
        function showMainTab(tabId, clickedButton) { showTab(tabId); } // Simplified as top/bottom are synced
        function showMainTabContent(tabId) {
            document.querySelectorAll('.content-area .tab-content').forEach(c => c.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            if (tabId === 'home-tab') renderActiveLists();
            if (tabId === 'history-tab') renderHistoryTab();
        }

        // --- Core List Data Structure (Helper) ---
        function getListCardData(listCardEl) {
            const id = listCardEl.id;
            const title = listCardEl.querySelector('.list-title').textContent;
            const creationDateISO = listCardEl.dataset.creationDate;
            const items = [];
            listCardEl.querySelectorAll('.item-list .item').forEach(itemEl => {
                items.push(getItemData(itemEl));
            });
            return { id, title, creationDateISO, items };
        }
        function getItemData(itemEl) {
            const name = itemEl.querySelector('.item-name').textContent;
            const weightEl = itemEl.querySelector('.item-weight');
            const weight = weightEl ? weightEl.textContent.replace(/[()]/g, '') : '';
            const purchased = itemEl.querySelector('input[type="checkbox"]').checked;
            const priceText = itemEl.querySelector('.price-value').textContent;
            const price = purchased && priceText ? parseFloat(priceText.replace('$', '')) : 0;
            const notes = itemEl.querySelector('.notes-value').textContent;
            const itemId = itemEl.dataset.itemId || `item-${Date.now()}-${Math.random().toString(36).substr(2, 5)}`; // Ensure item ID
            itemEl.dataset.itemId = itemId;
            return { id: itemId, name, weight, purchased, price, notes };
        }
        function findListIndex(listId, dataArray) { return dataArray.findIndex(list => list.id === listId); }
        function findItemIndex(itemId, itemsArray) { return itemsArray.findIndex(item => item.id === itemId); }


        // --- Active List Rendering & Management ---
        function renderActiveLists() {
            const listsContainer = document.getElementById('lists-container');
            listsContainer.innerHTML = ''; // Clear before re-render
            activeListsData.sort((a,b) => new Date(b.creationDateISO) - new Date(a.creationDateISO)); // Show newest first
            activeListsData.forEach(listData => {
                const listCard = createListCardDOM(listData, false); // false for not history
                listsContainer.appendChild(listCard);
            });
        }

        document.getElementById('masterAddListButton').addEventListener('click', () => {
            openModal('addNewListModal'); document.getElementById('newListTitleInput').focus();
        });

        function handleSaveNewList() {
            const title = document.getElementById('newListTitleInput').value.trim();
            if (!title) { alert("List title cannot be empty."); return; }
            const newListData = {
                id: `list-${Date.now()}`,
                title: title,
                creationDateISO: new Date().toISOString(),
                items: []
            };
            activeListsData.push(newListData);
            saveData(ACTIVE_LISTS_STORAGE_KEY, activeListsData);
            renderActiveLists(); // Re-render all active lists
            closeModal('addNewListModal');
        }

        function createListCardDOM(listData, isHistoryCard) {
            const creationDateString = new Date(listData.creationDateISO).toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });
            const listCard = document.createElement('section');
            listCard.classList.add('grocery-list-card');
            listCard.id = listData.id;
            listCard.dataset.creationDate = listData.creationDateISO;

            let listActionsHTML = `
                <button title="Download PDF" class="icon-btn download-pdf-btn">
                    <svg viewBox="0 0 24 24" width="18" height="18" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
                </button>
                <button title="Edit List" class="icon-btn edit-list-btn">
                    <svg viewBox="0 0 24 24" width="18" height="18" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
                </button>
                <button title="Archive List" class="icon-btn archive-list-btn">
                    <svg viewBox="0 0 24 24" width="18" height="18" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
                </button>`;
            
            listCard.innerHTML = `
                <div class="list-header">
                    <h2 class="list-title">${listData.title}</h2>
                    <div class="list-actions">${listActionsHTML}</div>
                </div>
                <p class="list-date-stamp">${creationDateString} (Created)</p>
                <ul class="item-list"></ul>
                <button class="add-item-to-list-btn">Add Item to This List</button>
                <div class="list-total-price"><span class="total-label">Total:</span> <span class="total-value">$0.00</span></div>`;

            const itemListUl = listCard.querySelector('.item-list');
            listData.items.forEach(itemData => {
                const itemLi = createItemDOM(itemData);
                itemListUl.appendChild(itemLi);
            });

            listCard.querySelector('.edit-list-btn').addEventListener('click', () => openEditListModal(listCard.id));
            listCard.querySelector('.archive-list-btn').addEventListener('click', () => openArchiveListModal(listCard.id));
            listCard.querySelector('.download-pdf-btn').addEventListener('click', () => downloadListAsPDF(listCard));
            listCard.querySelector('.add-item-to-list-btn').addEventListener('click', () => {
                currentListCardForAction = listCard.id; // Store ID
                openModal('addNewItemModal'); document.getElementById('newItemNameInput').focus();
            });
            updateListTotal(listCard);
            return listCard;
        }
        
        // --- Item Management within Active Lists ---
        function handleSaveNewItem() {
            const name = document.getElementById('newItemNameInput').value.trim();
            const weight = document.getElementById('newItemWeightInput').value.trim();
            if (!name) { alert("Item name cannot be empty."); return; }
            if (!currentListCardForAction) { alert("Error: No list selected."); return; }

            const listIndex = findListIndex(currentListCardForAction, activeListsData);
            if (listIndex === -1) return;

            const newItemData = {
                id: `item-${Date.now()}-${Math.random().toString(36).substr(2, 5)}`,
                name, weight, purchased: false, price: 0, notes: ''
            };
            activeListsData[listIndex].items.push(newItemData);
            saveData(ACTIVE_LISTS_STORAGE_KEY, activeListsData);
            renderActiveLists(); // Re-render to show new item
            closeModal('addNewItemModal');
        }

        function createItemDOM(itemData) {
            const itemLi = document.createElement('li');
            itemLi.classList.add('item');
            itemLi.dataset.itemId = itemData.id;
            itemLi.dataset.price = itemData.price || 0;

            itemLi.innerHTML = `
                <label class="checkbox-container"><input type="checkbox" ${itemData.purchased ? 'checked' : ''}></label>
                <div class="item-info">
                    <span class="item-name">${itemData.name}</span>
                    ${itemData.weight ? `<span class="item-weight">(${itemData.weight})</span>` : ''}
                </div>
                <span class="item-details">
                    <span class="price-value">${itemData.purchased && itemData.price > 0 ? `$${itemData.price.toFixed(2)}` : ''}</span>
                    <span class="notes-value">${itemData.notes || ''}</span>
                </span>
                <div class="item-actions-inline">
                    <button title="Edit Item" class="icon-btn edit-item-btn">
                        <svg viewBox="0 0 24 24" width="16" height="16" stroke="currentColor" stroke-width="2.5" fill="none" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
                    </button>
                    <button title="Delete Item" class="icon-btn delete-item-btn">
                        <svg viewBox="0 0 24 24" width="16" height="16" stroke="currentColor" stroke-width="2.5" fill="none" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                    </button>
                </div>`;
            itemLi.querySelector('input[type="checkbox"]').addEventListener('change', (e) => handleItemCheck(e.target));
            itemLi.querySelector('.edit-item-btn').addEventListener('click', () => openEditItemModal(itemLi.dataset.itemId, itemLi.closest('.grocery-list-card').id));
            itemLi.querySelector('.delete-item-btn').addEventListener('click', () => openDeleteItemConfirmModal(itemLi.dataset.itemId, itemLi.closest('.grocery-list-card').id));
            return itemLi;
        }
        
        function handleItemCheck(checkbox) {
            const itemLi = checkbox.closest('.item');
            const listCard = itemLi.closest('.grocery-list-card');
            const listIndex = findListIndex(listCard.id, activeListsData);
            const itemIndex = findItemIndex(itemLi.dataset.itemId, activeListsData[listIndex].items);

            if (checkbox.checked) {
                currentCheckbox = checkbox; // For price modal
                currentItemForAction = activeListsData[listIndex].items[itemIndex]; // Pass item data
                openModal('priceModal');
                document.getElementById('itemPriceInput').value = currentItemForAction.price > 0 ? currentItemForAction.price.toFixed(2) : '';
                document.getElementById('itemNotesInput').value = currentItemForAction.notes || '';
                document.getElementById('itemPriceInput').focus();
            } else {
                activeListsData[listIndex].items[itemIndex].purchased = false;
                activeListsData[listIndex].items[itemIndex].price = 0;
                activeListsData[listIndex].items[itemIndex].notes = '';
                saveData(ACTIVE_LISTS_STORAGE_KEY, activeListsData);
                renderActiveLists(); // Efficient would be to update just the item and total
            }
        }

        function closePriceModal(isConfirmed) {
            const itemLi = currentCheckbox.closest('.item');
            const listCard = itemLi.closest('.grocery-list-card');
            const listIndex = findListIndex(listCard.id, activeListsData);
            const itemIndex = findItemIndex(itemLi.dataset.itemId, activeListsData[listIndex].items);

            if (isConfirmed) {
                const price = parseFloat(document.getElementById('itemPriceInput').value) || 0;
                const notes = document.getElementById('itemNotesInput').value.trim();
                activeListsData[listIndex].items[itemIndex].purchased = true;
                activeListsData[listIndex].items[itemIndex].price = price;
                activeListsData[listIndex].items[itemIndex].notes = notes;
            } else { // Cancelled or no price, so uncheck
                 if (currentCheckbox) currentCheckbox.checked = false; // Uncheck the box visually
                 activeListsData[listIndex].items[itemIndex].purchased = false;
                 activeListsData[listIndex].items[itemIndex].price = 0;
                 activeListsData[listIndex].items[itemIndex].notes = '';
            }
            saveData(ACTIVE_LISTS_STORAGE_KEY, activeListsData);
            renderActiveLists(); // Re-render
            closeModal('priceModal');
            currentCheckbox = null;
            currentItemForAction = null;
        }

        function updateListTotal(listCardEl) { // Primarily for visual update after DOM manipulation
            if (!listCardEl) return;
            let total = 0;
            const listData = activeListsData.find(list => list.id === listCardEl.id);
            if(listData) {
                listData.items.forEach(item => {
                    if (item.purchased) total += (item.price || 0);
                });
            }
            const totalEl = listCardEl.querySelector('.list-total-price .total-value');
            if (totalEl) totalEl.textContent = `$${total.toFixed(2)}`;
        }
        
        // --- Edit List Title ---
        function openEditListModal(listId) {
            currentListCardForAction = listId; // Store ID
            const listData = activeListsData.find(list => list.id === listId);
            if (!listData) return;
            document.getElementById('editListTitleInput').value = listData.title;
            openModal('editListModal'); document.getElementById('editListTitleInput').focus();
        }
        function handleSaveListTitleEdit() {
            const listIndex = findListIndex(currentListCardForAction, activeListsData);
            if (listIndex === -1) return;
            const newTitle = document.getElementById('editListTitleInput').value.trim();
            if (newTitle) {
                activeListsData[listIndex].title = newTitle;
                saveData(ACTIVE_LISTS_STORAGE_KEY, activeListsData);
                renderActiveLists();
            }
            closeModal('editListModal');
        }

        // --- Archive List ---
        function openArchiveListModal(listId) {
            const listData = activeListsData.find(list => list.id === listId);
            if (!listData) return;
            document.getElementById('confirmModalTitle').textContent = "Archive List";
            document.getElementById('confirmModalMessage').textContent = `Archive list "${listData.title}"? It will be moved to History.`;
            document.getElementById('confirmModalConfirmBtn').textContent = "Archive";
            confirmModalCallback = () => {
                const listIndex = findListIndex(listId, activeListsData);
                if (listIndex > -1) {
                    const [archivedList] = activeListsData.splice(listIndex, 1);
                    archivedList.completionDateISO = new Date().toISOString(); // Add completion date
                    historyData.push(archivedList);
                    historyData.sort((a, b) => new Date(b.completionDateISO) - new Date(a.completionDateISO));
                    saveData(ACTIVE_LISTS_STORAGE_KEY, activeListsData);
                    saveData(HISTORY_STORAGE_KEY, historyData);
                    renderActiveLists();
                    renderHistoryTab(); // If history tab is active or needs update
                }
            };
            openModal('confirmModal');
        }

        // --- Edit Item ---
        function openEditItemModal(itemId, listId) {
            currentListCardForAction = listId; // list ID
            currentItemForAction = itemId; // item ID
            const listIndex = findListIndex(listId, activeListsData);
            if (listIndex === -1) return;
            const itemIndex = findItemIndex(itemId, activeListsData[listIndex].items);
            if (itemIndex === -1) return;
            const itemData = activeListsData[listIndex].items[itemIndex];

            document.getElementById('editItemNameInput').value = itemData.name;
            document.getElementById('editItemWeightInput').value = itemData.weight || '';
            openModal('editItemModal'); document.getElementById('editItemNameInput').focus();
        }
        function handleSaveItemEdit() {
            if (!currentItemForAction || !currentListCardForAction) return;
            const newName = document.getElementById('editItemNameInput').value.trim();
            const newWeight = document.getElementById('editItemWeightInput').value.trim();
            if (!newName) { alert("Item name cannot be empty."); return; }

            const listIndex = findListIndex(currentListCardForAction, activeListsData);
            const itemIndex = findItemIndex(currentItemForAction, activeListsData[listIndex].items);
            
            activeListsData[listIndex].items[itemIndex].name = newName;
            activeListsData[listIndex].items[itemIndex].weight = newWeight;
            saveData(ACTIVE_LISTS_STORAGE_KEY, activeListsData);
            renderActiveLists();
            closeModal('editItemModal');
        }

        // --- Delete Item from Active List ---
        function openDeleteItemConfirmModal(itemId, listId) {
            const listIndex = findListIndex(listId, activeListsData);
            if (listIndex === -1) return;
            const itemIndex = findItemIndex(itemId, activeListsData[listIndex].items);
            if (itemIndex === -1) return;
            const itemName = activeListsData[listIndex].items[itemIndex].name;

            document.getElementById('confirmModalTitle').textContent = "Delete Item";
            document.getElementById('confirmModalMessage').textContent = `Delete item "${itemName}" from this list?`;
            document.getElementById('confirmModalConfirmBtn').textContent = "Delete";
            confirmModalCallback = () => {
                activeListsData[listIndex].items.splice(itemIndex, 1);
                saveData(ACTIVE_LISTS_STORAGE_KEY, activeListsData);
                renderActiveLists();
            };
            openModal('confirmModal');
        }
        
        // --- Generic Confirmation Modal Closer ---
        function closeConfirmModal(isConfirmed) {
            if (isConfirmed && typeof confirmModalCallback === 'function') confirmModalCallback();
            confirmModalCallback = null; closeModal('confirmModal');
            currentListCardForAction = null; currentItemForAction = null;
        }


        // --- Render History Tab ---
        function renderHistoryTab() {
            const historyArea = document.getElementById('history-tab-content-area');
            historyArea.innerHTML = '';
            if (historyData.length === 0) {
                historyArea.innerHTML = '<p style="text-align: center; color: var(--text-light); margin-top: 20px;">No archived lists yet.</p>'; return;
            }
            const grouped = historyData.reduce((acc, list) => {
                const dateKey = new Date(list.completionDateISO).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
                if (!acc[dateKey]) acc[dateKey] = []; acc[dateKey].push(list); return acc;
            }, {});
            const sortedDateKeys = Object.keys(grouped).sort((a,b) => new Date(b) - new Date(a));

            for (const dateKey of sortedDateKeys) {
                const groupDiv = document.createElement('div'); groupDiv.classList.add('history-date-group');
                groupDiv.innerHTML = `<h4>${dateKey}</h4>`;
                grouped[dateKey].forEach(list => {
                    const card = createHistoryListCardDOM(list); // Use a dedicated DOM creator for history
                    groupDiv.appendChild(card);
                });
                historyArea.appendChild(groupDiv);
            }
        }

        function createHistoryListCardDOM(listData) {
            const originalCreationDate = new Date(listData.originalCreationDateISO || listData.creationDateISO).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            const card = document.createElement('div');
            card.classList.add('history-list-card');
            card.dataset.listId = listData.id; // Store ID for potential delete from history

            card.innerHTML = `
                <div class="history-list-header">
                    <div class="title-date-group">
                        <span class="list-title">${listData.title}</span>
                        <span class="original-date">(Created: ${originalCreationDate})</span>
                    </div>
                    <button title="Delete Permanently" class="icon-btn delete-history-btn">
                        <svg viewBox="0 0 24 24" width="16" height="16" stroke="crimson" stroke-width="2.5" fill="none" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
                    </button>
                    <span class="expand-icon icon-btn"></span> 
                </div>
                <ul class="history-item-list">
                    ${listData.items.map(item => `
                        <li class="history-item">
                            <div class="history-item-info">
                                <span class="name">${item.name}</span>
                                ${item.weight ? `<span class="weight">(${item.weight})</span>` : ''}
                            </div>
                            <div class="history-item-details">
                                ${item.purchased && typeof item.price === 'number' && item.price > 0 ? `<span class="price">$${item.price.toFixed(2)}</span>` : ''}
                                <span class="status">${item.purchased ? 'Purchased' : 'Not Purchased'}</span>
                                ${item.notes ? `<span class="notes">${item.notes}</span>` : ''}
                            </div>
                        </li>`).join('')}
                    ${listData.items.length === 0 ? '<li><p style="font-style:italic; color:var(--text-light); padding: 5px 0;">No items in this list.</p></li>' : ''}
                </ul>`;
            card.querySelector('.history-list-header').addEventListener('click', (e) => {
                // Prevent toggle if delete button is clicked
                if (!e.target.closest('.delete-history-btn')) {
                    card.classList.toggle('expanded');
                }
            });
            card.querySelector('.delete-history-btn').addEventListener('click', () => openDeleteFromHistoryModal(listData.id));
            return card;
        }
        
        function openDeleteFromHistoryModal(listId){
            const listIndex = findListIndex(listId, historyData);
            if(listIndex === -1) return;
            const listTitle = historyData[listIndex].title;

            document.getElementById('confirmModalTitle').textContent = "Delete from History";
            document.getElementById('confirmModalMessage').textContent = `Permanently delete list "${listTitle}" from history? This cannot be undone.`;
            document.getElementById('confirmModalConfirmBtn').textContent = "Delete";
            confirmModalCallback = () => {
                historyData.splice(listIndex, 1);
                saveData(HISTORY_STORAGE_KEY, historyData);
                renderHistoryTab();
            };
            openModal('confirmModal');
        }


        // --- Download List as PDF --- (Same as your last enhanced version)
        function downloadListAsPDF(listCardEl) {
            const doc = new jsPDF({orientation: 'p', unit: 'mm', format: 'a4'});
            const listTitle = listCardEl.querySelector('.list-title').textContent;
            const listDate = listCardEl.querySelector('.list-date-stamp').textContent;
            const listTotal = listCardEl.querySelector('.list-total-price .total-value').textContent;
            const pageMargin = 15, pageWidth = doc.internal.pageSize.getWidth(), pageHeight = doc.internal.pageSize.getHeight();
            const contentWidth = pageWidth - (2 * pageMargin); let yPos = pageMargin + 10;
            const lineSpacing = 6, itemIndent = pageMargin + 5, detailsIndent = itemIndent + 5;

            doc.setFont("helvetica", "bold"); doc.setFontSize(20); doc.setTextColor(50, 50, 50);
            doc.text(listTitle, pageWidth / 2, yPos, { align: 'center' }); yPos += lineSpacing * 2;
            doc.setFont("helvetica", "normal"); doc.setFontSize(10); doc.setTextColor(100, 100, 100);
            doc.text(listDate, pageWidth / 2, yPos, { align: 'center' }); yPos += lineSpacing * 2.5;
            doc.setFont("helvetica", "normal"); doc.setFontSize(11); doc.setTextColor(0, 0, 0);

            listCardEl.querySelectorAll('.item-list .item').forEach((itemEl) => {
                if (yPos > pageHeight - pageMargin - 20) { addPdfFooter(doc, pageMargin, pageHeight); doc.addPage(); yPos = pageMargin + 10; }
                const checkbox = itemEl.querySelector('input[type="checkbox"]'); const name = itemEl.querySelector('.item-name').textContent;
                const weightEl = itemEl.querySelector('.item-weight'); const weight = weightEl ? weightEl.textContent : '';
                const priceVal = itemEl.querySelector('.price-value').textContent; const notesVal = itemEl.querySelector('.notes-value').textContent;
                const statusSymbol = checkbox.checked ? "☑" : "☐";
                let itemText = `${statusSymbol}  ${name} ${weight}`; let textLines = doc.splitTextToSize(itemText, contentWidth - 20);
                doc.text(textLines, itemIndent, yPos); yPos += (textLines.length * lineSpacing * 0.8);
                if (priceVal || notesVal) {
                     if (yPos > pageHeight - pageMargin - 20) { addPdfFooter(doc, pageMargin, pageHeight); doc.addPage(); yPos = pageMargin + 10; }
                    doc.setFontSize(9); doc.setTextColor(80, 80, 80); let detailsString = "";
                    if (priceVal) detailsString += `${priceVal}`; if (notesVal) detailsString += (priceVal ? "  |  " : "") + `Notes: ${notesVal}`;
                    let detailTextLines = doc.splitTextToSize(detailsString, contentWidth - 25);
                    doc.text(detailTextLines, detailsIndent, yPos); yPos += (detailTextLines.length * lineSpacing * 0.7);
                    doc.setFontSize(11); doc.setTextColor(0,0,0);
                }
                yPos += lineSpacing * 0.5; doc.setDrawColor(220, 220, 220);
                doc.line(itemIndent -2 , yPos, pageWidth - pageMargin - 5, yPos); yPos += lineSpacing * 0.7;
            });
            if (yPos > pageHeight - pageMargin - 20) { addPdfFooter(doc, pageMargin, pageHeight); doc.addPage(); yPos = pageMargin + 10; }
            yPos += lineSpacing; doc.setLineWidth(0.5); doc.setDrawColor(150,150,150);
            doc.line(pageMargin, yPos, pageWidth - pageMargin, yPos); yPos += lineSpacing;
            doc.setFont("helvetica", "bold"); doc.setFontSize(14); doc.setTextColor(50,50,50);
            doc.text(`Total: ${listTotal}`, pageWidth - pageMargin, yPos, { align: 'right'});
            addPdfFooter(doc, pageMargin, pageHeight);
            const safeFileName = listTitle.replace(/[^a-z0-9]/gi, '_').toLowerCase();
            doc.save(`${safeFileName}_shopspot_list.pdf`);
        }
        function addPdfFooter(doc, margin, pageH) {
            doc.setFont("helvetica", "italic"); doc.setFontSize(8); doc.setTextColor(150, 150, 150);
            const pageStr = "Page " + doc.internal.getNumberOfPages();
            doc.text(pageStr, doc.internal.pageSize.getWidth() - margin, pageH - (margin/2) + 3, { align: 'right' });
            doc.text("Generated by ShopSpot", margin, pageH - (margin/2) + 3);
        }
        
        // --- Initial Setup ---
        document.addEventListener('DOMContentLoaded', () => {
            activeListsData = loadData(ACTIVE_LISTS_STORAGE_KEY);
            historyData = loadData(HISTORY_STORAGE_KEY);
            
            showMainTab('home-tab', document.querySelector('.bottom-nav .nav-item.active')); // Default to home tab
            // renderActiveLists() and renderHistoryTab() will be called by showMainTabContent
        });
    </script>
</body>
</html>
